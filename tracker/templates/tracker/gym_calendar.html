{% extends 'tracker/base.html' %}

{% block title %}Calendrier Salle {{ current_year }} - Fitness Tracker{% endblock %}

{% block content %}
<div class="animate-in">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div class="d-flex align-items-center gap-3">
            <a href="?year={{ prev_year }}" class="btn btn-outline-light btn-sm">â—€ {{ prev_year }}</a>
            <h1 style="font-weight: 700; margin: 0;">ðŸ“… {{ current_year }}</h1>
            <a href="?year={{ next_year }}" class="btn btn-outline-light btn-sm">{{ next_year }} â–¶</a>
        </div>
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addSessionModal">
            âž• Nouvelle SÃ©ance
        </button>
    </div>
</div>

<!-- Legend -->
<div class="d-flex justify-content-center gap-3 mb-4 flex-wrap">
    <span class="badge" style="background-color: #FF6B6B;">Push: {{ stats.PUSH }}</span>
    <span class="badge" style="background-color: #4834d4;">Pull: {{ stats.PULL }}</span>
    <span class="badge" style="background-color: #2ecc71; color: #fff;">Lower: {{ stats.LOWER }}</span>
    <span class="badge" style="background-color: #17c0eb; color: #fff;">Upper: {{ stats.UPPER }}</span>
</div>

<style>
    /* Force dark mode for select in this page + modal */
    .form-select {
        background-color: #2b2d42 !important;
        color: #ffffff !important;
        border-color: rgba(255, 255, 255, 0.1) !important;
    }

    .dot-upper {
        background: #17c0eb;
    }

    /* Rest of existing styles */

    .year-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
    }

    .month-card {
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        padding: 15px;
    }

    .month-title {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 10px;
        color: #fff;
        text-align: center;
    }

    .month-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 2px;
    }

    .day-cell {
        aspect-ratio: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
        color: #888;
        border-radius: 50%;
        cursor: pointer;
        position: relative;
    }

    .day-cell:hover {
        background: rgba(255, 255, 255, 0.1);
        color: #fff;
    }

    .day-cell.has-session {
        font-weight: bold;
        color: #fff;
    }

    .day-cell.today {
        border: 1px solid #0d6efd;
    }

    /* Indicators */
    .dot {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        position: absolute;
        bottom: 2px;
    }

    .dot-push {
        background: #FF6B6B;
    }

    .dot-pull {
        background: #4834d4;
    }

    .dot-lower {
        background: #2ecc71;
    }

    .dot-cardio {
        background: #f0932b;
    }

    .dot-mix {
        background: #fff;
    }
</style>

<div class="year-grid">
    {% for month in months_data %}
    <div class="month-card">
        <div class="month-title">{{ month.name }}</div>

        <div class="d-flex justify-content-between mb-2 px-1 text-muted" style="font-size: 0.7rem;">
            <span>L</span><span>M</span><span>M</span><span>J</span><span>V</span><span>S</span><span>D</span>
        </div>

        <div class="month-grid">
            {% for week in month.weeks %}
            {% for day in week %}
            {% if day %}
            <div class="day-cell {% if day.sessions %}has-session{% endif %} {% if day.is_today %}today{% endif %}"
                onclick="openAddModal('{{ day.date.isoformat }}', '{% if day.sessions %}{{ day.sessions.0.id }}{% endif %}', '{% if day.sessions %}{{ day.sessions.0.type }}{% endif %}')"
                title="{% for s in day.sessions %}{{ s.type }}\n{% endfor %}">
                {{ day.day }}

                {% if day.sessions %}
                {% if day.sessions|length > 1 %}
                <div class="dot dot-mix"></div>
                {% else %}
                {% with s=day.sessions.0 %}
                <div class="dot 
                                                {% if s.type == 'PUSH' %}dot-push
                                                {% elif s.type == 'PULL' %}dot-pull
                                                {% elif s.type == 'LOWER' %}dot-lower
                                                {% elif s.type == 'UPPER' %}dot-upper
                                                {% elif s.type == 'CARDIO' %}dot-cardio
                                                {% else %}dot-mix{% endif %}">
                </div>
                {% endwith %}
                {% endif %}
                {% endif %}
            </div>
            {% else %}
            <div></div>
            {% endif %}
            {% endfor %}
            {% endfor %}
        </div>
    </div>
    {% endfor %}
</div>

</div>

<!-- Modal Ajout SÃ©ance (Same as before) -->
<div class="modal fade" id="addSessionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content" style="background: #1a1a2e; border: 1px solid rgba(255,255,255,0.1);">
            <div class="modal-header">
                <h5 class="modal-title">Nouvelle SÃ©ance</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form method="post" action="{% url 'add_gym_session' %}">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label class="form-label">Date</label>
                        <input type="date" name="date" id="modalDateInput" class="form-control"
                            value="{{ today|date:'Y-m-d' }}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Type de sÃ©ance</label>
                        <select name="session_type" class="form-select">
                            <option value="PUSH">Push</option>
                            <option value="PULL">Pull</option>
                            <option value="UPPER">Upper Body</option>
                            <option value="LOWER">Lower Body</option>
                            <option value="CARDIO">Cardio</option>
                        </select>
                    </div>

                    <input type="hidden" name="session_id" id="modalSessionId">
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-success flex-grow-1">Enregistrer</button>
                        <button type="button" id="btnDeleteSession" class="btn btn-danger" style="display: none;"
                            onclick="deleteSession()">Supprimer</button>
                    </div>
                </form>

                <form id="deleteForm" method="post" action="{% url 'delete_gym_session_calendar' %}"
                    style="display:none;">
                    {% csrf_token %}
                    <input type="hidden" name="session_id" id="deleteSessionId">
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    function openAddModal(date, sessionId, sessionType) {
        document.getElementById('modalDateInput').value = date;
        document.getElementById('modalSessionId').value = sessionId || '';
        document.getElementById('deleteSessionId').value = sessionId || '';

        const modalTitle = document.querySelector('#addSessionModal .modal-title');
        const deleteBtn = document.getElementById('btnDeleteSession');
        const sessionSelect = document.querySelector('select[name="session_type"]');

        if (sessionId) {
            // Edit Mode
            modalTitle.innerText = "Modifier la sÃ©ance"; // Or just remove it? User said "enlever le 'Nouvelle SÃ©ance'". 
            // "Garder 'Nouvelle SÃ©ance' seulement quand on crÃ©e une nouvelle sÃ©ance"
            // So if editing, maybe just say "SÃ©ance" or "Modifier" or stick to request?
            // "enlever le 'Nouvelle SÃ©ance' du pop-up qui apparaÃ®t" -> Does it mean EMPTY title?
            // "Garder 'Nouvelle SÃ©ance' seulement quand on crÃ©e" -> Implies when NOT creating, do NOT show 'Nouvelle SÃ©ance'.
            // I will set it to "Modifier SÃ©ance" or just "DÃ©tails SÃ©ance". Let's use "Modifier la sÃ©ance" for clarity, or just "SÃ©ance".
            // User: "avoir un bouton pour supprimer... et enlever le 'Nouvelle SÃ©ance'... Garder 'Nouvelle SÃ©ance' seulement quand on crÃ©e".
            modalTitle.innerText = "SÃ©ance";
            deleteBtn.style.display = 'block';
            if (sessionType) sessionSelect.value = sessionType;
        } else {
            // New Mode
            modalTitle.innerText = "Nouvelle SÃ©ance";
            deleteBtn.style.display = 'none';
            sessionSelect.value = 'PUSH'; // Default
        }

        new bootstrap.Modal(document.getElementById('addSessionModal')).show();
    }

    function deleteSession() {
        if (confirm('Supprimer cette sÃ©ance ?')) {
            document.getElementById('deleteForm').submit();
        }
    }
</script>
{% endblock %}