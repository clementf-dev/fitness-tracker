{% extends 'tracker/base.html' %}

{% block title %}{% if editing %}Modifier{% else %}Ajouter{% endif %} un aliment - Fitness Tracker{% endblock %}

{% block extra_css %}
<style>
    .search-results {
        max-height: 400px;
        overflow-y: auto;
        margin-top: 1rem;
    }

    .search-result-item {
        padding: 1rem;
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        margin-bottom: 0.5rem;
        cursor: pointer;
        transition: all 0.2s;
    }

    .search-result-item:hover {
        background: rgba(255, 255, 255, 0.08);
        border-color: #667eea;
    }

    .search-result-item .name {
        font-weight: 600;
        font-size: 1rem;
    }

    .search-result-item .brand {
        color: #ffffff;
        font-size: 0.85rem;
    }

    .search-result-item .macros {
        display: flex;
        gap: 1rem;
        margin-top: 0.5rem;
        font-size: 0.9rem;
    }

    .search-loading {
        text-align: center;
        padding: 2rem;
        color: #ffffff;
    }

    .search-error {
        background: rgba(245, 87, 108, 0.1);
        border: 1px solid rgba(245, 87, 108, 0.3);
        color: #f5576c;
        padding: 1rem;
        border-radius: 8px;
        margin-top: 1rem;
    }

    .macro-preview {
        display: flex;
        gap: 1rem;
        padding: 1rem;
        background: rgba(255, 255, 255, 0.03);
        border-radius: 8px;
        margin-top: 1rem;
    }

    .macro-preview-item {
        text-align: center;
        flex: 1;
    }

    .macro-preview-value {
        font-size: 1.5rem;
        font-weight: 600;
    }

    .macro-preview-label {
        font-size: 0.8rem;
        color: #ffffff;
    }
</style>
{% endblock %}

{% block content %}
<div class="animate-in">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 style="font-weight: 700; font-size: 2rem;">
            {% if editing %}‚úèÔ∏è Modifier{% else %}‚ûï Ajouter{% endif %} un aliment
        </h1>
        <div class="d-flex gap-2">
            <a href="{% url 'food_database' %}" class="btn btn-primary">üìö Banque d'aliments</a>
            <a href="{% url 'meal_templates' %}" class="btn btn-primary">üìã Repas types</a>
            <a href="{% url 'calories_dashboard' %}" class="btn btn-primary">‚Üê Retour</a>
        </div>
    </div>

    <div class="row">
        <!-- Formulaire -->
        <div class="col-lg-6">
            <div class="card">
                <div class="card-body">
                    <form method="post">
                        {% csrf_token %}

                        <div class="mb-3">
                            <label class="form-label">Nom de l'aliment *</label>
                            {{ form.name }}
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Marque</label>
                            {{ form.brand }}
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Portion (g) *</label>
                                {{ form.serving_size }}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Calories *</label>
                                {{ form.calories }}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label class="form-label" style="color: #e74c3c;">Prot√©ines (g) *</label>
                                {{ form.protein }}
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label" style="color: #3498db;">Glucides (g) *</label>
                                {{ form.carbs }}
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label" style="color: #f39c12;">Lipides (g) *</label>
                                {{ form.fat }}
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label" style="color: #2ecc71;">Fibres (g)</label>
                                {{ form.fiber }}
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Code-barres</label>
                            {{ form.barcode }}
                        </div>

                        <button type="submit" class="btn btn-primary w-100">
                            {% if editing %}üíæ Enregistrer les modifications{% else %}‚ûï Ajouter √† la banque{% endif %}
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Recherche en ligne -->
        <div class="col-lg-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title mb-3" style="color: #ffffff;">üîç Rechercher en ligne</h5>
                    <p style="color: #ffffff;" class="small mb-3">Recherchez un produit et cliquez dessus pour
                        pr√©-remplir le
                        formulaire.</p>

                    <div class="input-group">
                        <input type="text" id="search-query" class="form-control"
                            placeholder="Rechercher un produit...">
                        <button type="button" id="search-btn" class="btn btn-primary">Rechercher</button>
                    </div>

                    <div id="search-results" class="search-results"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const searchBtn = document.getElementById('search-btn');
    const searchInput = document.getElementById('search-query');
    const resultsDiv = document.getElementById('search-results');

    searchBtn.addEventListener('click', performSearch);
    searchInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            performSearch();
        }
    });

    async function performSearch() {
        const query = searchInput.value.trim();
        if (!query) return;

        resultsDiv.innerHTML = '<div class="search-loading">üîÑ Recherche en cours...</div>';

        try {
            const response = await fetch(`/api/food/search/?q=${encodeURIComponent(query)}`);
            const data = await response.json();

            if (data.error) {
                resultsDiv.innerHTML = `<div class="search-error">${data.error}</div>`;
                return;
            }

            if (data.results.length === 0) {
                resultsDiv.innerHTML = '<div class="search-error">Aucun r√©sultat trouv√©. Essayez un autre terme.</div>';
                return;
            }

            let html = '';
            for (const item of data.results) {
                // Style sp√©cial pour les aliments g√©n√©riques
                const isGeneric = item.is_generic;
                const borderStyle = isGeneric ? 'border-left: 4px solid #2ecc71;' : '';
                const badge = isGeneric ? '<span style="background: #2ecc71; color: #fff; padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; margin-left: 8px;">‚úì Brut</span>' : '';

                // Info sur le poids par unit√©
                const unitInfo = item.unit_weight
                    ? `<span style="color: #2ecc71; font-weight: 600;">(${item.unit_weight}g/unit√©)</span>`
                    : '';

                html += `
                    <div class="search-result-item" style="${borderStyle}" onclick="fillForm(${JSON.stringify(item).replace(/"/g, '&quot;')})">
                        <div class="name" style="color: #ffffff;">${item.name} ${unitInfo} ${badge}</div>
                        ${item.brand ? `<div class="brand" style="color: rgba(255,255,255,0.6);">${item.brand}</div>` : ''}
                        <div class="macros">
                            <span style="color: #f5576c;"><strong>${item.calories}</strong> kcal/100g</span>
                            <span style="color: #e74c3c;">P: ${item.protein}g</span>
                            <span style="color: #3498db;">G: ${item.carbs}g</span>
                            <span style="color: #f39c12;">L: ${item.fat}g</span>
                            <span style="color: #2ecc71;">F: ${item.fiber || 0}g</span>
                        </div>
                    </div>
                `;
            }

            resultsDiv.innerHTML = html;

        } catch (error) {
            resultsDiv.innerHTML = `<div class="search-error">Erreur de connexion: ${error.message}</div>`;
        }
    }

    function fillForm(item) {
        document.querySelector('[name="name"]').value = item.name;
        document.querySelector('[name="brand"]').value = item.brand || '';
        document.querySelector('[name="serving_size"]').value = item.serving_size || 100;
        document.querySelector('[name="calories"]').value = item.calories;
        document.querySelector('[name="protein"]').value = item.protein;
        document.querySelector('[name="carbs"]').value = item.carbs;
        document.querySelector('[name="fat"]').value = item.fat;
        document.querySelector('[name="fiber"]').value = item.fiber || 0;
        document.querySelector('[name="barcode"]').value = item.barcode || '';

        // Scroll to form
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
</script>
{% endblock %}